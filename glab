#! /bin/bash

REPO=""
SUB_PROJECT="infini-cloud"
BASE_URL="https://gitlab.infini-ai.com"

usage() {
    cat << EOF
Usage: $0 [OPTIONS] <repository>

Opens a GitLab repository in the browser.

OPTIONS:
    -h, --help      Show this help message
    -p, --pipeline  Open the pipelines page
    -m, --merge     Open the merge requests page
    -t, --tags      Open the tags page

ARGUMENTS:
    <repository>    Repository name (optional if in a git repository)
EOF
}

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            exit 0
            ;;
        -p|--pipeline)
            PAGE="-/pipelines"
            ;;
        -m|--merge)
            PAGE="-/merge_requests"
            ;;
        -t|--tags)
            PAGE="-/tags"
            ;;
        -*)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
        *)
            if [ -z "$REPO" ]; then
                REPO="$1"
            else
                echo "Multiple repositories specified: $REPO and $1" >&2
                exit 1
            fi
            ;;
    esac
    shift
done

if [ -z "$REPO" ]; then
    # Try to get repository path from git remote
    if REMOTE_URL=$(git remote get-url origin 2>/dev/null); then
        # Extract path from git remote URL
        # Handle both https://gitlab.infini-ai.com/path/repo.git and git@gitlab.infini-ai.com:path/repo.git
        REPO_PATH=$(echo "$REMOTE_URL" | sed -E 's|^.*gitlab\.infini-ai\.com[:/]||; s|\.git$||')
        TARGET_URL="$BASE_URL/$REPO_PATH/$PAGE"
    else
        # Fall back to using directory name
        REPO=$(basename $(pwd))
        TARGET_URL="$BASE_URL/$SUB_PROJECT/$REPO/$PAGE"
    fi
else
    TARGET_URL="$BASE_URL/$SUB_PROJECT/$REPO/$PAGE"
fi

open $TARGET_URL

